# ZtbAi 维护手册

## 📋 概述

本手册为ZtbAi投标文件AI智能编辑系统的日常维护提供详细指导，包括系统监控、故障排除、性能优化和安全维护等方面。

## 🔧 日常维护任务

### 每日检查
- [ ] 系统健康状态检查
- [ ] 服务运行状态确认
- [ ] 日志文件检查
- [ ] 磁盘空间监控
- [ ] 数据库状态检查

### 每周检查
- [ ] 性能指标分析
- [ ] 错误日志汇总
- [ ] 用户反馈处理
- [ ] 安全更新检查
- [ ] 备份验证

### 每月检查
- [ ] 系统性能优化
- [ ] 数据库维护
- [ ] 依赖包更新
- [ ] 安全审计
- [ ] 容量规划评估

## 📊 系统监控

### 1. 健康检查命令
```bash
# 基础健康检查
curl http://localhost:9958/health

# 详细系统状态
curl http://localhost:9958/api/status

# 性能监控数据
curl http://localhost:9958/api/monitoring/performance

# Agent系统状态
curl http://localhost:9958/api/agent/status
```

### 2. 服务状态检查
```bash
# 检查进程状态
pm2 status

# 查看服务日志
pm2 logs ztbai-backend

# 重启服务
pm2 restart ztbai-backend

# 重载配置
pm2 reload ztbai-backend
```

### 3. 系统资源监控
```bash
# CPU和内存使用
top
htop

# 磁盘使用情况
df -h
du -sh /opt/ztbai/*

# 网络连接
netstat -tlnp | grep :9958
ss -tlnp | grep :9958
```

## 📝 日志管理

### 1. 日志文件位置
```
/opt/ztbai/backend/logs/
├── error.log          # 错误日志
├── out.log            # 输出日志
├── combined.log       # 综合日志
└── access.log         # 访问日志
```

### 2. 日志查看命令
```bash
# 查看最新日志
tail -f /opt/ztbai/backend/logs/combined.log

# 查看错误日志
tail -100 /opt/ztbai/backend/logs/error.log

# 搜索特定错误
grep -i "error" /opt/ztbai/backend/logs/combined.log

# 按时间过滤日志
grep "2025-01-17" /opt/ztbai/backend/logs/combined.log
```

### 3. 日志轮转配置
```bash
# 检查日志轮转配置
cat /etc/logrotate.d/ztbai

# 手动执行日志轮转
sudo logrotate -f /etc/logrotate.d/ztbai

# 测试日志轮转配置
sudo logrotate -d /etc/logrotate.d/ztbai
```

## 🗄️ 数据库维护

### 1. SQLite数据库检查
```bash
# 进入数据库
sqlite3 /opt/ztbai/backend/ztbai.db

# 检查表结构
.tables
.schema projects

# 检查数据完整性
PRAGMA integrity_check;

# 优化数据库
VACUUM;

# 分析查询性能
ANALYZE;
```

### 2. 数据库备份
```bash
# 创建备份
sqlite3 /opt/ztbai/backend/ztbai.db ".backup /backup/ztbai_$(date +%Y%m%d).db"

# 验证备份
sqlite3 /backup/ztbai_$(date +%Y%m%d).db "PRAGMA integrity_check;"

# 恢复备份
cp /backup/ztbai_20250117.db /opt/ztbai/backend/ztbai.db
```

### 3. 数据库性能优化
```sql
-- 重建索引
REINDEX;

-- 更新统计信息
ANALYZE;

-- 清理临时文件
PRAGMA temp_store = MEMORY;

-- 设置缓存大小
PRAGMA cache_size = 10000;
```

## 🚨 故障排除

### 1. 常见问题诊断

#### 服务无法启动
```bash
# 检查端口占用
sudo lsof -i :9958
sudo netstat -tlnp | grep :9958

# 检查配置文件
python -c "import json; print(json.load(open('ztbai_config.json')))"

# 检查依赖
pip check
```

#### 性能问题
```bash
# 检查系统负载
uptime
iostat 1 5

# 检查内存使用
free -h
cat /proc/meminfo

# 检查磁盘I/O
iotop
```

#### AI服务连接问题
```bash
# 测试AI服务连接
curl -X POST "http://localhost:9958/api/unified-config/ai/openai/test"

# 检查AI配置
cat /opt/ztbai/backend/ztbai_config.json | jq '.ai_providers'
```

### 2. 错误代码对照表

| 错误代码 | 含义 | 解决方案 |
|---------|------|---------|
| 400 | 请求参数错误 | 检查API调用参数 |
| 404 | 资源不存在 | 确认项目ID或路径正确 |
| 409 | 资源冲突 | 等待当前操作完成 |
| 500 | 内部服务器错误 | 查看错误日志，重启服务 |
| 502 | 上游服务错误 | 检查AI服务配置和连接 |

### 3. 紧急恢复程序

#### 服务完全停止
```bash
# 1. 停止所有相关进程
pm2 stop all
sudo pkill -f "python.*new_api_server"

# 2. 检查系统资源
df -h
free -h

# 3. 重启服务
cd /opt/ztbai
pm2 start ecosystem.config.js

# 4. 验证服务
curl http://localhost:9958/health
```

#### 数据库损坏
```bash
# 1. 停止服务
pm2 stop ztbai-backend

# 2. 备份当前数据库
cp /opt/ztbai/backend/ztbai.db /backup/corrupted_$(date +%Y%m%d).db

# 3. 尝试修复
sqlite3 /opt/ztbai/backend/ztbai.db "PRAGMA integrity_check;"

# 4. 如果无法修复，恢复最新备份
cp /backup/ztbai_latest.db /opt/ztbai/backend/ztbai.db

# 5. 重启服务
pm2 start ztbai-backend
```

## 🔒 安全维护

### 1. 安全检查清单
- [ ] 系统补丁更新
- [ ] 依赖包安全更新
- [ ] 访问日志审计
- [ ] 异常登录检查
- [ ] 文件权限验证
- [ ] SSL证书有效期检查

### 2. 安全更新命令
```bash
# 系统更新
sudo apt update && sudo apt upgrade -y

# Python依赖安全检查
pip-audit

# Node.js依赖安全检查
npm audit

# 检查文件权限
find /opt/ztbai -type f -perm /o+w -ls
```

### 3. 访问控制维护
```bash
# 检查防火墙状态
sudo ufw status

# 查看访问日志
tail -100 /var/log/nginx/access.log

# 检查异常访问
grep "404\|403\|500" /var/log/nginx/access.log | tail -20
```

## 📈 性能优化

### 1. 系统性能调优
```bash
# 调整文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化内核参数
echo "net.core.somaxconn = 65536" >> /etc/sysctl.conf
echo "vm.swappiness = 10" >> /etc/sysctl.conf
sysctl -p
```

### 2. 应用性能优化
```bash
# 启用Gzip压缩 (Nginx)
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript;

# 设置缓存头
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. 数据库性能优化
```sql
-- 定期执行的优化命令
PRAGMA optimize;
PRAGMA wal_checkpoint(TRUNCATE);
VACUUM;
ANALYZE;
```

## 🔄 更新和升级

### 1. 应用更新流程
```bash
# 1. 备份当前版本
cp -r /opt/ztbai /backup/ztbai_$(date +%Y%m%d)

# 2. 停止服务
pm2 stop ztbai-backend

# 3. 拉取最新代码
cd /opt/ztbai
git pull origin main

# 4. 更新依赖
cd backend
pip install -r requirements.txt

cd ../frontend
npm install
npm run build

# 5. 重启服务
pm2 start ztbai-backend

# 6. 验证更新
curl http://localhost:9958/health
```

### 2. 依赖更新
```bash
# Python依赖更新
pip list --outdated
pip install --upgrade package_name

# Node.js依赖更新
npm outdated
npm update
```

### 3. 回滚程序
```bash
# 如果更新失败，回滚到备份版本
pm2 stop ztbai-backend
rm -rf /opt/ztbai
cp -r /backup/ztbai_20250117 /opt/ztbai
pm2 start ztbai-backend
```

## 📞 支持和联系

### 技术支持流程
1. **问题记录**: 详细记录问题现象和错误信息
2. **日志收集**: 收集相关日志文件
3. **环境信息**: 记录系统环境和配置信息
4. **重现步骤**: 提供问题重现的详细步骤

### 紧急联系方式
- **系统管理员**: [联系方式]
- **开发团队**: [联系方式]
- **技术支持**: [联系方式]

### 文档和资源
- **项目文档**: `/opt/ztbai/docs/`
- **API文档**: `http://localhost:9958/docs`
- **配置示例**: `/opt/ztbai/backend/ztbai_config.json.example`

## 📊 监控指标

### 关键性能指标 (KPI)
- **系统可用性**: > 99.5%
- **平均响应时间**: < 100ms
- **错误率**: < 1%
- **CPU使用率**: < 80%
- **内存使用率**: < 85%
- **磁盘使用率**: < 90%

### 告警阈值
- **响应时间**: > 500ms
- **错误率**: > 5%
- **CPU使用率**: > 90%
- **内存使用率**: > 95%
- **磁盘使用率**: > 95%
- **服务不可用**: > 5分钟

---

**手册版本**: v3.0  
**最后更新**: 2025-01-17  
**维护团队**: ZtbAi开发团队
