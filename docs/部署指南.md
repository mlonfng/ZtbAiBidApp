# ZtbAi 部署指南

## 📋 概述

本指南详细介绍ZtbAi投标文件AI智能编辑系统的部署方法，包括开发环境、生产环境和Docker容器化部署。

## 🏗️ 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用       │    │   后端API服务    │    │   AI服务提供商   │
│  React + TS     │◄──►│  FastAPI + Python│◄──►│  OpenAI/Claude  │
│  Port: 3000     │    │  Port: 9958     │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       
         ▼                       ▼                       
┌─────────────────┐    ┌─────────────────┐              
│   静态文件       │    │   SQLite数据库   │              
│   Build输出     │    │   项目数据存储   │              
└─────────────────┘    └─────────────────┘              
```

## 🔧 环境要求

### 基础要求
- **操作系统**: Windows 10+, macOS 10.14+, Ubuntu 18.04+
- **Python**: 3.8+ (推荐3.9+)
- **Node.js**: 16.0+ (推荐18.0+)
- **内存**: 最低4GB，推荐8GB+
- **存储**: 最低10GB可用空间

### 可选要求
- **Docker**: 20.0+ (容器化部署)
- **Nginx**: 1.18+ (反向代理)
- **SSL证书**: HTTPS部署

## 🚀 开发环境部署

### 1. 克隆项目
```bash
git clone <repository-url>
cd ZtbAiBidApp_202507210900
```

### 2. 后端环境设置
```bash
cd backend

# 创建虚拟环境 (推荐)
python -m venv venv
source venv/bin/activate  # Linux/macOS
# 或
venv\Scripts\activate     # Windows

# 安装依赖
pip install -r requirements.txt

# 配置AI服务 (可选)
cp ztbai_config.json.example ztbai_config.json
# 编辑配置文件，添加AI API密钥
```

### 3. 前端环境设置
```bash
cd frontend

# 安装依赖
npm install

# 或使用yarn
yarn install
```

### 4. 启动开发服务

**启动后端**:
```bash
cd backend
python new_api_server.py
```
✅ 后端服务: http://localhost:9958

**启动前端**:
```bash
cd frontend
npm start
```
✅ 前端应用: http://localhost:3000

### 5. 验证部署
```bash
# 健康检查
curl http://localhost:9958/health

# 运行测试
cd backend
python tests/simple_e2e_test.py
```

## 🏭 生产环境部署

### 1. 服务器准备
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础软件
sudo apt install -y python3 python3-pip nodejs npm nginx git

# 安装PM2 (进程管理)
sudo npm install -g pm2
```

### 2. 项目部署
```bash
# 克隆项目到生产目录
sudo mkdir -p /opt/ztbai
sudo chown $USER:$USER /opt/ztbai
cd /opt/ztbai
git clone <repository-url> .

# 后端部署
cd backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 前端构建
cd ../frontend
npm install
npm run build
```

### 3. 配置文件设置
```bash
# 后端配置
cd /opt/ztbai/backend
cp ztbai_config.json.example ztbai_config.json
# 编辑配置文件，设置生产环境参数

# 创建日志目录
mkdir -p logs
```

### 4. 进程管理配置
创建 `ecosystem.config.js`:
```javascript
module.exports = {
  apps: [{
    name: 'ztbai-backend',
    script: 'new_api_server.py',
    cwd: '/opt/ztbai/backend',
    interpreter: '/opt/ztbai/backend/venv/bin/python',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 9958
    },
    error_file: '/opt/ztbai/backend/logs/error.log',
    out_file: '/opt/ztbai/backend/logs/out.log',
    log_file: '/opt/ztbai/backend/logs/combined.log'
  }]
};
```

### 5. Nginx配置
创建 `/etc/nginx/sites-available/ztbai`:
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    location / {
        root /opt/ztbai/frontend/build;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:9958;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:9958;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 6. 启动服务
```bash
# 启用Nginx配置
sudo ln -s /etc/nginx/sites-available/ztbai /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 启动后端服务
cd /opt/ztbai
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

## 🐳 Docker部署

### 1. 创建Dockerfile
```dockerfile
# 多阶段构建
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci --only=production
COPY frontend/ ./
RUN npm run build

FROM python:3.9-slim AS backend
WORKDIR /app
COPY backend/requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
COPY backend/ ./
COPY --from=frontend-builder /app/frontend/build ./static

EXPOSE 9958
CMD ["python", "new_api_server.py"]
```

### 2. 创建docker-compose.yml
```yaml
version: '3.8'

services:
  ztbai:
    build: .
    ports:
      - "9958:9958"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
    environment:
      - NODE_ENV=production
      - PYTHONPATH=/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9958/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - ztbai
    restart: unless-stopped
```

### 3. 部署命令
```bash
# 构建和启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 更新部署
docker-compose pull
docker-compose up -d --force-recreate
```

## 🔒 安全配置

### 1. 防火墙设置
```bash
# Ubuntu/Debian
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 2. SSL证书配置
```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

### 3. 环境变量安全
```bash
# 创建环境变量文件
cat > /opt/ztbai/.env << EOF
AI_API_KEY=your-secret-key
DATABASE_URL=sqlite:///data/ztbai.db
SECRET_KEY=your-secret-key
DEBUG=false
EOF

# 设置权限
chmod 600 /opt/ztbai/.env
```

## 📊 监控和维护

### 1. 日志管理
```bash
# 日志轮转配置
sudo cat > /etc/logrotate.d/ztbai << EOF
/opt/ztbai/backend/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 ztbai ztbai
    postrotate
        pm2 reload ztbai-backend
    endscript
}
EOF
```

### 2. 性能监控
```bash
# 安装监控工具
npm install -g pm2-logrotate
pm2 install pm2-server-monit

# 查看性能
pm2 monit
pm2 status
```

### 3. 备份策略
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/ztbai"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
cp /opt/ztbai/backend/ztbai.db $BACKUP_DIR/ztbai_$DATE.db

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz /opt/ztbai/backend/ztbai_config.json

# 清理旧备份 (保留30天)
find $BACKUP_DIR -name "*.db" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
```

## 🚨 故障排除

### 常见问题

#### 1. 端口占用
```bash
# 查看端口占用
sudo netstat -tlnp | grep :9958
sudo lsof -i :9958

# 杀死进程
sudo kill -9 <PID>
```

#### 2. 权限问题
```bash
# 修复文件权限
sudo chown -R ztbai:ztbai /opt/ztbai
sudo chmod -R 755 /opt/ztbai
```

#### 3. 依赖问题
```bash
# 重新安装依赖
cd /opt/ztbai/backend
pip install --upgrade -r requirements.txt

cd /opt/ztbai/frontend
npm install --force
```

#### 4. 数据库问题
```bash
# 检查数据库
sqlite3 /opt/ztbai/backend/ztbai.db ".tables"

# 重建数据库
rm /opt/ztbai/backend/ztbai.db
# 重启服务，数据库会自动重建
```

### 性能优化

#### 1. 系统优化
```bash
# 增加文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化内核参数
echo "net.core.somaxconn = 65536" >> /etc/sysctl.conf
sysctl -p
```

#### 2. 应用优化
- 启用Gzip压缩
- 配置静态文件缓存
- 使用CDN加速
- 数据库查询优化

## 📞 支持与维护

### 联系方式
- **技术支持**: 查看项目文档
- **问题反馈**: 提交GitHub Issue
- **功能建议**: 提交Feature Request

### 维护计划
- **日常监控**: 系统状态、性能指标
- **定期备份**: 数据库、配置文件
- **安全更新**: 依赖包、系统补丁
- **性能优化**: 定期性能测试和优化

---

**文档版本**: v3.0  
**最后更新**: 2025-01-17  
**维护团队**: ZtbAi开发团队
